<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toimintakyvyn arviointi ADL-, IADL- ja CFS-asteikolla</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      max-width: 520px;
      margin: 0 auto;
      padding: 1.5rem;
      background: #f5f5f0;
      color: #1a1a1a;
      min-height: 100vh;
    }
    h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #2c3e50;
    }
    .phase-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #5a6c7d;
      margin-bottom: 0.25rem;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .item-title {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      line-height: 1.35;
    }
    .criteria-box {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.9rem 1rem;
      margin-bottom: 0.75rem;
      border-left: 4px solid #7a9fb8;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #333;
    }
    .criteria-box.avustetaan { border-left-color: #b85c2d; }
    .criteria-box .criteria-label {
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.35rem;
      color: #5a6c7d;
    }
    .criteria-box .criteria-list { margin: 0; padding-left: 1.1rem; }
    .criteria-box .criteria-list li { margin-bottom: 0.2rem; }
    .criteria-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    @media (max-width: 480px) {
      .criteria-row { grid-template-columns: 1fr; }
    }
    .choices {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .choice {
      flex: 1;
      min-width: 140px;
      padding: 1rem 1.25rem;
      border: 2px solid #ddd;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      transition: border-color 0.15s, background 0.15s, color 0.15s;
    }
    .choice:hover {
      border-color: #7a9fb8;
      background: #f0f6fa;
    }
    .choice.selected-itse {
      border-color: #2d7a4a;
      background: #e8f5ec;
      color: #1a5c34;
    }
    .choice.selected-avustetaan {
      border-color: #b85c2d;
      background: #fef3eb;
      color: #8b3a15;
    }
    .nav {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.25rem;
      flex-wrap: wrap;
    }
    .btn {
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.05s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
      background: #2c3e50;
      color: #fff;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:disabled {
      background: #aaa;
      cursor: not-allowed;
      opacity: 0.8;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn-secondary:hover { background: #d0d0d0; }
    .progress {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    #summary {
      display: none;
    }
    #summary.visible {
      display: block;
    }
    .summary-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #2c3e50;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #f8f8f8;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    .summary-row.highlight {
      background: #fff3e0;
      border: 1px solid #ffcc80;
    }
    .summary-label { font-weight: 500; }
    .summary-value { font-weight: 700; font-size: 1.1rem; }
    .screen { display: none; }
    .screen.active { display: block; }
    .intro-card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .intro-text {
      font-size: 0.95rem;
      line-height: 1.5;
      color: #444;
      margin-bottom: 1.25rem;
    }
    .intro-btn { margin-top: 0.5rem; margin-right: 0.5rem; }
    .intro-reference { font-size: 0.85rem; color: #666; margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid #eee; line-height: 1.4; }
    .intro-reference a { color: #5a6c7d; }
    .intro-license { font-size: 0.8rem; color: #777; margin-top: 1rem; line-height: 1.4; }
    .manual-input-row { margin-bottom: 1rem; }
    .manual-input-row label { display: block; font-size: 0.95rem; font-weight: 500; margin-bottom: 0.35rem; color: #333; }
    .manual-input { width: 100%; max-width: 6rem; padding: 0.5rem 0.75rem; font-size: 1rem; border: 2px solid #ddd; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Toimintakyvyn arviointi ADL-, IADL- ja CFS-asteikolla</h1>

  <div id="intro-screen" class="screen active">
    <div class="card intro-card">
      <p class="intro-text">Tällä laskurilla määritetään ensin yhteispistemäärä ADL- ja IADL-toiminnoille, joissa tutkittava tarvitsee ulkopuolista apua.</p>
      <p class="intro-text">Tämän kyselyn jälkeen laskuri etenee CFS-luokituksen määrittäviin kysymyksiin.</p>
      <p class="intro-text">Jos tiedät jo kuinka monessa ADL- ja IADL-toiminnossa tutkittava tarvitsee apua ja tahdot hypätä suoraan CFS-luokituksen määritykseen, klikkaa nappulaan "Siirry CFS-luokituksen arviointiin".</p>
      <button type="button" class="btn btn-primary intro-btn" id="intro-start">Aloita ADL- ja IADL-toimintojen arviointi</button>
      <button type="button" class="btn btn-secondary intro-btn" id="intro-skip-to-cfs">Siirry CFS-luokituksen arviointiin</button>
      <p class="intro-reference">Tämä arviointityökalu perustuu Rockwoodin työryhmän esittelemään vuokaavioon (<a href="https://doi.org/10.1093/ageing/afab006" target="_blank" rel="noopener">https://doi.org/10.1093/ageing/afab006</a>).</p>
      <p class="intro-license">© Ville Langén, 2026 — MIT-lisenssi. Tämän työkalun käyttö ei vaadi viittausta allekirjoittaneen nimeen; vain tämän sivun koodin uudelleenkäyttö tai muokkaus vaatii kyseisen viittauksen.</p>
    </div>
  </div>

  <div id="manual-adl-iadl-screen" class="screen">
    <div class="phase-label">ADL- ja IADL-pisteet</div>
    <div class="card">
      <p class="intro-text" style="margin-bottom: 1rem;">Syötä niiden ADL- ja IADL-toimintojen lukumäärät, joissa tutkittava tarvitsee ulkopuolista apua.</p>
      <div class="manual-input-row">
        <label for="manual-adl">Tarvitsee ulkopuolista apua ADL-toiminnoissa (0–6)</label>
        <input type="number" id="manual-adl" min="0" max="6" value="0" class="manual-input">
      </div>
      <div class="manual-input-row">
        <label for="manual-iadl">Tarvitsee ulkopuolista apua IADL-toiminnoissa (0–8)</label>
        <input type="number" id="manual-iadl" min="0" max="8" value="0" class="manual-input">
      </div>
      <div class="nav" style="margin-top: 1rem;">
        <button type="button" class="btn btn-primary" id="manual-adl-iadl-submit">Jatka CFS-luokitukseen</button>
      </div>
    </div>
  </div>

  <div id="adl-screen" class="screen">
    <div class="phase-label">Toimintakyky ADL</div>
    <div class="progress" id="adl-progress"></div>
    <div class="card">
      <div class="item-title" id="adl-item-name"></div>
      <div class="criteria-row" id="adl-criteria"></div>
      <div class="choices" id="adl-choices">
        <button type="button" class="choice" data-value="itse">Itse</button>
        <button type="button" class="choice" data-value="avustetaan">Avustetaan</button>
      </div>
      <div class="nav">
        <button type="button" class="btn btn-secondary" id="adl-prev">Edellinen</button>
        <button type="button" class="btn btn-primary" id="adl-next" disabled>Seuraava</button>
      </div>
    </div>
  </div>

  <div id="iadl-screen" class="screen">
    <div class="phase-label">Toimintakyky IADL</div>
    <div class="progress" id="iadl-progress"></div>
    <div class="card">
      <div class="item-title" id="iadl-item-name"></div>
      <div class="criteria-row" id="iadl-criteria"></div>
      <div class="choices" id="iadl-choices">
        <button type="button" class="choice" data-value="itse">Itse</button>
        <button type="button" class="choice" data-value="avustetaan">Avustetaan</button>
      </div>
      <div class="nav">
        <button type="button" class="btn btn-secondary" id="iadl-prev">Edellinen</button>
        <button type="button" class="btn btn-primary" id="iadl-next" disabled>Seuraava</button>
      </div>
    </div>
  </div>

  <div id="summary" class="screen">
    <div class="card">
      <div class="summary-title">Arviointi valmis</div>
      <div class="summary-row highlight">
        <span class="summary-label">Tarvitsee ulkopuolista apua ADL-toiminnoissa (kpl)</span>
        <span class="summary-value" id="adl-avustetaan-count">0</span>
      </div>
      <div class="summary-row highlight">
        <span class="summary-label">Tarvitsee eri IADL-toiminnoissa apua (kpl)</span>
        <span class="summary-value" id="iadl-avustetaan-count">0</span>
      </div>
      <p class="intro-text" style="margin-top: 1rem; margin-bottom: 0.75rem;">Jos tahdot jatkaa CFS-luokituksen määritykseen, klikkaa alla näkyvää aloitusnappia.</p>
      <button type="button" class="btn btn-primary intro-btn" id="cfs-start">Aloita CFS-luokitus</button>
    </div>
  </div>

  <div id="cfs-screen" class="screen">
    <div class="phase-label" id="cfs-phase-label">CFS-luokitus</div>
    <div class="card">
      <div class="item-title" id="cfs-question-title"></div>
      <div class="choices" id="cfs-choices"></div>
      <div class="nav" id="cfs-nav" style="margin-top: 1rem;">
        <button type="button" class="btn btn-secondary" id="cfs-prev">Edellinen</button>
      </div>
    </div>
    <div id="cfs-result" class="card" style="display: none;">
      <div class="summary-title">CFS-luokitus</div>
      <div class="summary-row highlight">
        <span class="summary-label">Tulos</span>
        <span class="summary-value" id="cfs-result-value">–</span>
      </div>
    </div>
  </div>

  <script>
    const ADL_ITEMS = [
      { name: 'Peseytyminen', itse: ['selviytyy omatoimisesti', 'ymmärtää itse peseytymisen tarpeen'], avustetaan: ['joku mukana peseytymistilanteessa', 'sanallinen ohjaus'] },
      { name: 'Pukeutuminen', itse: ['osaa valita adekvaatisti vaatteet päälleen', 'kykenee hoitamaan pukeutumisen täysin omatoimisesti'], avustetaan: ['vaatteet laitetaan valmiiksi puettavaksi', 'sanallinen ohjaus', 'varmistaminen, että on pukeutunut'] },
      { name: 'WC-käynnit', itse: ['tunnistaa wc-käynnin tarpeen adekvaatisti', 'suoriutuu wc-käynnistä täysin omatoimisesti'], avustetaan: ['tarvitsee ohjausta wc-käyntiin', 'tarvitsee apua esim. housujen laskussa tai nostossa'] },
      { name: 'Siirtyminen', itse: ['liikkuu omatoimisesti (ainakin) sisällä'], avustetaan: ['tarvitsee apua esim. sängystä tai tuolista nousemiseen', 'tarvitsee sanallista ohjausta liikkumisen toteuttamiseen'] },
      { name: 'Pidätyskyky', itse: ['voi olla inkosuoja käytössä, mutta hoitaa itse vaihtamisen ja siihen liittyvän hygienian'], avustetaan: ['tarvitsee apua jollakin tavalla virtsan tai ulosteen karkailun suhteen'] },
      { name: 'Syöminen', itse: ['tunnistaa tarpeen syödä itse', 'ottaa itse ruoan esim. kattilasta'], avustetaan: ['ruoka annetaan valmiiksi tarjoiltuna eteen', 'sanallisen ohjauksen tai kannustuksen tarve, jotta syöminen onnistuu'] }
    ];

    const IADL_ITEMS = [
      { name: 'Puhelimen käyttö', itse: ['puhelimen käyttö on adekvaattia kaikilta osin', 'osaa soittaa ja vastata puhelimeen'], avustetaan: ['ei osaa enää käyttää puhelinta'] },
      { name: 'Ostosten teko', itse: ['käy itse kaupassa / osaa tehdä asianmukaisen ostoslistan joko omaiselle tai esim. lähikauppaan / osaa itse tilata adekvaatisti toimitettavat ostokset'], avustetaan: ['kotona ei ole ruokaa/ ruokatarvikkeita, joista tehdä ruokaa (ei lainkaan tai epäadekvaatteja tarvikkeita)'] },
      { name: 'Ruoan valmistus', itse: ['valmistaa itse ruoan asianmukaisesti'], avustetaan: ['käyttää jonkun toisen valmistamia ruokia, esim. valmisaterioita'] },
      { name: 'Kodinhoito', itse: ['kodin jokapäiväinen hoitaminen sujuu kuten ennenkin', 'siivooja tai omainen hoitaa suuremmat siivoukset esim. x1/kk'], avustetaan: ['kodin yleisiisteys muuttunut', 'koti vaalii siivousta, roskien vientiä yms.'] },
      { name: 'Pyykinpesu', itse: ['osaa käyttää pyykkikonetta adekvaatisti', 'ymmärtää vaatteiden pesun tarpeen'], avustetaan: ['ohjataan pyykinpesussa tai pyykkihuolto hoidetaan puolesta'] },
      { name: 'Liikkuminen kulkuvälineillä', itse: ['liikkuu omatoimisesti, joko omalla autolla tai julkisilla kulkuvälineillä', 'osaa/ymmärtää itse tilata taksin'], avustetaan: ['tarvitsee apua liikkumisen suunnitteluun ja toteutukseen'] },
      { name: 'Vastuu lääkityksestä', itse: ['hoitaa lääkkeiden ottamisen adekvaatisti itse', 'jakaa itse dosettiin'], avustetaan: ['lääkkeiden ottaminen ja/tai jakaminen vaatii jonkinlaisen ulkopuolisen tarkistuksen', 'joku on huolissaan lääkityksen asianmukaisesta toteutumisesta'] },
      { name: 'Raha-asioiden hoitaminen', itse: ['hoitaa raha-asiat täysin omatoimisesti ja asianmukaisesti', 'ei ole huolta', 'ymmärtää oman/perheen rahaliikenteen, vaikka teknisesti joku hoitaa esim. laskujen maksamisen'], avustetaan: ['joku on huolissaan raha-asioiden asianmukaisesta toteutumisesta'] }
    ];

    const state = {
      adl: [],
      iadl: [],
      adlIndex: 0,
      iadlIndex: 0,
      adlCountOverride: null,
      iadlCountOverride: null,
      cfs: {
        terminal_ill: null,
        chronic_conditions: null,
        self_reported_health: null,
        everything_effort: null,
        sports: null
      },
      cfsStepOrder: []
    };

    function initState() {
      state.adl = ADL_ITEMS.map(() => null);
      state.iadl = IADL_ITEMS.map(() => null);
      state.adlIndex = 0;
      state.iadlIndex = 0;
    }

    function renderCriteria(item) {
      const itseHtml = '<div class="criteria-box"><div class="criteria-label">Itse</div><ul class="criteria-list">' +
        item.itse.map(s => '<li>' + s + '</li>').join('') + '</ul></div>';
      const avustetaanHtml = '<div class="criteria-box avustetaan"><div class="criteria-label">Avustetaan</div><ul class="criteria-list">' +
        item.avustetaan.map(s => '<li>' + s + '</li>').join('') + '</ul></div>';
      return itseHtml + avustetaanHtml;
    }

    function setChoice(choicesEl, value) {
      choicesEl.querySelectorAll('.choice').forEach(btn => {
        btn.classList.remove('selected-itse', 'selected-avustetaan');
        if (btn.dataset.value === value) {
          btn.classList.add(value === 'itse' ? 'selected-itse' : 'selected-avustetaan');
        }
      });
    }

    function showAdl() {
      document.getElementById('adl-screen').classList.add('active');
      document.getElementById('iadl-screen').classList.remove('active');
      document.getElementById('summary').classList.remove('visible');
      renderAdl();
    }

    function renderAdl() {
      const i = state.adlIndex;
      const nameEl = document.getElementById('adl-item-name');
      const progressEl = document.getElementById('adl-progress');
      const choicesEl = document.getElementById('adl-choices');
      const nextBtn = document.getElementById('adl-next');
      const prevBtn = document.getElementById('adl-prev');

      const item = ADL_ITEMS[i];
      nameEl.textContent = item.name;
      document.getElementById('adl-criteria').innerHTML = renderCriteria(item);
      progressEl.textContent = `${i + 1} / ${ADL_ITEMS.length}`;
      setChoice(choicesEl, state.adl[i]);
      nextBtn.disabled = state.adl[i] === null;
      nextBtn.textContent = i === ADL_ITEMS.length - 1 ? 'Jatka IADL-arviointiin' : 'Seuraava';
      prevBtn.style.visibility = i === 0 ? 'hidden' : 'visible';
    }

    function showIadl() {
      document.getElementById('adl-screen').classList.remove('active');
      document.getElementById('iadl-screen').classList.add('active');
      document.getElementById('summary').classList.remove('visible');
      renderIadl();
    }

    function renderIadl() {
      const i = state.iadlIndex;
      const nameEl = document.getElementById('iadl-item-name');
      const progressEl = document.getElementById('iadl-progress');
      const choicesEl = document.getElementById('iadl-choices');
      const nextBtn = document.getElementById('iadl-next');
      const prevBtn = document.getElementById('iadl-prev');

      const item = IADL_ITEMS[i];
      nameEl.textContent = item.name;
      document.getElementById('iadl-criteria').innerHTML = renderCriteria(item);
      progressEl.textContent = `${i + 1} / ${IADL_ITEMS.length}`;
      setChoice(choicesEl, state.iadl[i]);
      nextBtn.disabled = state.iadl[i] === null;
      nextBtn.textContent = i === IADL_ITEMS.length - 1 ? 'Näytä yhteenveto' : 'Seuraava';
      prevBtn.style.visibility = i === 0 ? 'hidden' : 'visible';
    }

    function getAdlCount() {
      if (state.adlCountOverride !== null) return state.adlCountOverride;
      return state.adl.filter(v => v === 'avustetaan').length;
    }
    function getIadlCount() {
      if (state.iadlCountOverride !== null) return state.iadlCountOverride;
      return state.iadl.filter(v => v === 'avustetaan').length;
    }

    function showSummary() {
      document.getElementById('adl-screen').classList.remove('active');
      document.getElementById('iadl-screen').classList.remove('active');
      document.getElementById('cfs-screen').classList.remove('active');
      document.getElementById('manual-adl-iadl-screen').classList.remove('active');
      document.getElementById('summary').classList.add('visible');

      const adlAvustetaan = getAdlCount();
      const iadlAvustetaan = getIadlCount();

      document.getElementById('adl-avustetaan-count').textContent = adlAvustetaan;
      document.getElementById('iadl-avustetaan-count').textContent = iadlAvustetaan;
    }

    function getCfsStep() {
      const adl = getAdlCount();
      const iadl = getIadlCount();
      const c = state.cfs;

      if (c.terminal_ill === null) {
        return { type: 'question', id: 'terminal_ill', title: 'Onko potilas terminaalisesti sairas?', options: [{ value: 'yes', label: 'Kyllä' }, { value: 'no', label: 'Ei' }] };
      }
      if (c.terminal_ill === 'yes') {
        return { type: 'result', value: adl <= 2 ? 9 : 8 };
      }
      if (c.terminal_ill === 'no') {
        if (adl >= 3) return { type: 'result', value: 7 };
        if (adl >= 1) return { type: 'result', value: 6 };
        if (adl === 0) {
          if (iadl >= 5) return { type: 'result', value: 6 };
          if (iadl >= 1) return { type: 'result', value: 5 };
          if (iadl === 0) {
            if (c.chronic_conditions === null) {
              return { type: 'question', id: 'chronic_conditions', title: 'Kroonisten sairauksien lukumäärä?', options: [{ value: '0-9', label: '0–9' }, { value: '10+', label: '10 tai enemmän' }] };
            }
            if (c.chronic_conditions === '10+') return { type: 'result', value: 4 };
            if (c.self_reported_health === null) {
              return { type: 'question', id: 'self_reported_health', title: 'Oma arvio terveydentilasta?', options: [
                { value: 'kohtalainen', label: 'Kohtalainen/huono' },
                { value: 'erinomainen', label: 'Erinomainen' },
                { value: 'hyva', label: 'Tosi hyvä / hyvä' }
              ]};
            }
            if (c.self_reported_health === 'kohtalainen') return { type: 'result', value: 4 };
            if (c.self_reported_health === 'erinomainen') {
              if (c.everything_effort === null) {
                return { type: 'question', id: 'everything_effort', title: 'Kuinka usein mikä vain tuntuu raskaalta tehdä?', options: [
                  { value: 'koko_ajan', label: 'Koko ajan (5-7 päivää viikossa)' },
                  { value: 'harvoin', label: 'Harvoin / ei koskaan (alle 1 päivä/viikko)' },
                  { value: 'toisinaan', label: 'Toisinaan (1-4 päivää/viikko)' }
                ]};
              }
              if (c.everything_effort === 'koko_ajan') return { type: 'result', value: 4 };
              if (c.everything_effort === 'harvoin') {
                if (c.sports === null) {
                  return { type: 'question', id: 'sports', title: 'Osallistuuko kohtalaiseen tai raskaaseen liikuntaan / virkistystoimintaan?', options: [{ value: 'yes', label: 'Kyllä' }, { value: 'no', label: 'Ei' }] };
                }
                return { type: 'result', value: c.sports === 'yes' ? 1 : 2 };
              }
              if (c.everything_effort === 'toisinaan') {
                if (c.sports === null) {
                  return { type: 'question', id: 'sports', title: 'Osallistuuko kohtalaiseen tai raskaaseen liikuntaan / virkistystoimintaan?', options: [{ value: 'yes', label: 'Kyllä' }, { value: 'no', label: 'Ei' }] };
                }
                return { type: 'result', value: c.sports === 'yes' ? 2 : 3 };
              }
            }
            if (c.self_reported_health === 'hyva') {
              if (c.everything_effort === null) {
                return { type: 'question', id: 'everything_effort', title: 'Kuinka usein mikä vain tuntuu raskaalta tehdä?', options: [
                  { value: 'koko_ajan', label: 'Koko ajan (5-7 päivää viikossa)' },
                  { value: 'harvoin', label: 'Harvoin / ei koskaan (alle 1 päivä/viikko)' },
                  { value: 'toisinaan', label: 'Toisinaan (1-4 päivää/viikko)' }
                ]};
              }
              if (c.everything_effort === 'koko_ajan') return { type: 'result', value: 4 };
              if (c.everything_effort === 'harvoin' || c.everything_effort === 'toisinaan') {
                if (c.sports === null) {
                  return { type: 'question', id: 'sports', title: 'Osallistuuko kohtalaiseen tai raskaaseen liikuntaan / virkistystoimintaan?', options: [{ value: 'yes', label: 'Kyllä' }, { value: 'no', label: 'Ei' }] };
                }
                return { type: 'result', value: c.sports === 'yes' ? 2 : 3 };
              }
            }
          }
        }
      }
      return { type: 'result', value: '-' };
    }

    function getCfsLastStepId() {
      const adl = getAdlCount();
      const iadl = getIadlCount();
      const c = state.cfs;
      if (c.sports !== null) return 'sports';
      if (c.everything_effort !== null) return 'everything_effort';
      if (c.self_reported_health !== null) return 'self_reported_health';
      if (c.chronic_conditions !== null) return 'chronic_conditions';
      if (c.terminal_ill !== null) return 'terminal_ill';
      return null;
    }

    function renderCfs() {
      const step = getCfsStep();
      const card = document.querySelector('#cfs-screen .card');
      const resultEl = document.getElementById('cfs-result');
      const navEl = document.getElementById('cfs-nav');

      if (step.type === 'result') {
        document.getElementById('cfs-phase-label').style.display = 'none';
        card.style.display = 'none';
        resultEl.style.display = 'block';
        document.getElementById('cfs-result-value').textContent = step.value;
        navEl.style.visibility = 'hidden';
        return;
      }

      document.getElementById('cfs-phase-label').style.display = '';
      card.style.display = 'block';
      resultEl.style.display = 'none';
      document.getElementById('cfs-question-title').textContent = step.title;
      const choicesEl = document.getElementById('cfs-choices');
      choicesEl.innerHTML = step.options.map(opt =>
        '<button type="button" class="choice" data-value="' + opt.value + '">' + opt.label + '</button>'
      ).join('');
      choicesEl.querySelectorAll('.choice').forEach(btn => {
        btn.addEventListener('click', () => {
          state.cfs[step.id] = btn.dataset.value;
          renderCfs();
        });
      });
      navEl.style.visibility = step.id === 'terminal_ill' ? 'hidden' : 'visible';
    }

    function resetCfsState() {
      state.cfs = {
        terminal_ill: null,
        chronic_conditions: null,
        self_reported_health: null,
        everything_effort: null,
        sports: null
      };
    }

    function cfsGoBack() {
      const last = getCfsLastStepId();
      if (last) state.cfs[last] = null;
      renderCfs();
    }

    document.getElementById('intro-start').addEventListener('click', () => {
      state.adlCountOverride = null;
      state.iadlCountOverride = null;
      document.getElementById('intro-screen').classList.remove('active');
      document.getElementById('manual-adl-iadl-screen').classList.remove('active');
      showAdl();
    });

    document.getElementById('intro-skip-to-cfs').addEventListener('click', () => {
      document.getElementById('intro-screen').classList.remove('active');
      document.getElementById('adl-screen').classList.remove('active');
      document.getElementById('iadl-screen').classList.remove('active');
      document.getElementById('summary').classList.remove('visible');
      document.getElementById('cfs-screen').classList.remove('active');
      document.getElementById('manual-adl-iadl-screen').classList.add('active');
      document.getElementById('manual-adl').value = '0';
      document.getElementById('manual-iadl').value = '0';
    });

    document.getElementById('manual-adl-iadl-submit').addEventListener('click', () => {
      const adlVal = parseInt(document.getElementById('manual-adl').value, 10);
      const iadlVal = parseInt(document.getElementById('manual-iadl').value, 10);
      state.adlCountOverride = Math.min(6, Math.max(0, isNaN(adlVal) ? 0 : adlVal));
      state.iadlCountOverride = Math.min(8, Math.max(0, isNaN(iadlVal) ? 0 : iadlVal));
      document.getElementById('manual-adl-iadl-screen').classList.remove('active');
      document.getElementById('cfs-screen').classList.add('active');
      resetCfsState();
      renderCfs();
    });

    document.getElementById('cfs-start').addEventListener('click', () => {
      document.getElementById('summary').classList.remove('visible');
      document.getElementById('cfs-screen').classList.add('active');
      resetCfsState();
      renderCfs();
    });

    document.getElementById('cfs-prev').addEventListener('click', cfsGoBack);

    // ADL handlers
    document.getElementById('adl-choices').addEventListener('click', (e) => {
      const btn = e.target.closest('.choice');
      if (!btn) return;
      const value = btn.dataset.value;
      state.adl[state.adlIndex] = value;
      setChoice(document.getElementById('adl-choices'), value);
      document.getElementById('adl-next').disabled = false;
    });

    document.getElementById('adl-next').addEventListener('click', () => {
      if (state.adlIndex < ADL_ITEMS.length - 1) {
        state.adlIndex++;
        renderAdl();
      } else {
        showIadl();
      }
    });

    document.getElementById('adl-prev').addEventListener('click', () => {
      if (state.adlIndex > 0) {
        state.adlIndex--;
        renderAdl();
      }
    });

    // IADL handlers
    document.getElementById('iadl-choices').addEventListener('click', (e) => {
      const btn = e.target.closest('.choice');
      if (!btn) return;
      const value = btn.dataset.value;
      state.iadl[state.iadlIndex] = value;
      setChoice(document.getElementById('iadl-choices'), value);
      document.getElementById('iadl-next').disabled = false;
    });

    document.getElementById('iadl-next').addEventListener('click', () => {
      if (state.iadlIndex < IADL_ITEMS.length - 1) {
        state.iadlIndex++;
        renderIadl();
      } else {
        showSummary();
      }
    });

    document.getElementById('iadl-prev').addEventListener('click', () => {
      if (state.iadlIndex > 0) {
        state.iadlIndex--;
        renderIadl();
      }
    });

    initState();
    renderAdl();
  </script>
</body>
</html>
